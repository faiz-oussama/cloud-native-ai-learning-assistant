{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "environmentName": {
            "type": "string",
            "defaultValue": "learningassistant",
            "metadata": {
                "description": "Environment name (dev, test, prod)"
            }
        },
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Location for all resources"
            }
        },
        "postgresAdminUsername": {
            "type": "string",
            "metadata": {
                "description": "PostgreSQL administrator user name"
            }
        },
        "postgresAdminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "PostgreSQL administrator password"
            }
        },
        "containerAppsEnvironmentName": {
            "type": "string",
            "defaultValue": "learningassistant-env",
            "metadata": {
                "description": "Name of the Container Apps environment"
            }
        }
    },
    "variables": {
        "uniqueString": "[uniqueString(resourceGroup().id)]",
        "containerRegistryName": "[concat('acr', variables('uniqueString'))]",
        "postgresServerName": "[concat('postgres-', variables('uniqueString'))]",
        "serviceBusNamespaceName": "[concat('sb-', variables('uniqueString'))]",
        "storageAccountName": "[concat('storage', variables('uniqueString'))]",
        "cosmosDbAccountName": "[concat('cosmosdb-', variables('uniqueString'))]",
        "aiSearchServiceName": "[concat('aisearch-', variables('uniqueString'))]",
        "keyVaultName": "[concat('kv-', variables('uniqueString'))]",
        "appInsightsName": "[concat('appinsights-', variables('uniqueString'))]"
    },
    "resources": [
        {
            "type": "Microsoft.ContainerRegistry/registries",
            "apiVersion": "2023-01-01-preview",
            "name": "[variables('containerRegistryName')]",
            "location": "[parameters('location')]",
            "sku": {
                "name": "Basic"
            },
            "properties": {
                "adminUserEnabled": true
            }
        },
        {
            "type": "Microsoft.DBforPostgreSQL/flexibleServers",
            "apiVersion": "2023-03-01-preview",
            "name": "[variables('postgresServerName')]",
            "location": "[parameters('location')]",
            "sku": {
                "name": "Standard_B1ms",
                "tier": "Burstable"
            },
            "properties": {
                "administratorLogin": "[parameters('postgresAdminUsername')]",
                "administratorLoginPassword": "[parameters('postgresAdminPassword')]",
                "version": "13",
                "storage": {
                    "storageSizeGB": 32
                },
                "backup": {
                    "backupRetentionDays": 7,
                    "geoRedundantBackup": "Disabled"
                }
            }
        },
        {
            "type": "Microsoft.ServiceBus/namespaces",
            "apiVersion": "2022-10-01-preview",
            "name": "[variables('serviceBusNamespaceName')]",
            "location": "[parameters('location')]",
            "sku": {
                "name": "Standard",
                "tier": "Standard"
            }
        },
        {
            "type": "Microsoft.ServiceBus/namespaces/queues",
            "apiVersion": "2022-10-01-preview",
            "name": "[concat(variables('serviceBusNamespaceName'), '/rag-ingest-queue')]",
            "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', variables('serviceBusNamespaceName'))]"
            ],
            "properties": {
                "lockDuration": "PT1M",
                "maxSizeInMegabytes": 1024,
                "requiresDuplicateDetection": false,
                "requiresSession": false,
                "defaultMessageTimeToLive": "P14D",
                "deadLetteringOnMessageExpiration": false,
                "enableBatchedOperations": true,
                "maxDeliveryCount": 10
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts",
            "apiVersion": "2023-01-01",
            "name": "[variables('storageAccountName')]",
            "location": "[parameters('location')]",
            "sku": {
                "name": "Standard_LRS"
            },
            "kind": "StorageV2"
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts",
            "apiVersion": "2023-04-15",
            "name": "[variables('cosmosDbAccountName')]",
            "location": "[parameters('location')]",
            "properties": {
                "databaseAccountOfferType": "Standard",
                "consistencyPolicy": {
                    "defaultConsistencyLevel": "Session"
                },
                "locations": [
                    {
                        "locationName": "[parameters('location')]",
                        "failoverPriority": 0
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Search/searchServices",
            "apiVersion": "2022-09-01",
            "name": "[variables('aiSearchServiceName')]",
            "location": "[parameters('location')]",
            "sku": {
                "name": "basic"
            },
            "properties": {
                "replicaCount": 1,
                "partitionCount": 1,
                "hostingMode": "default"
            }
        },
        {
            "type": "Microsoft.App/managedEnvironments",
            "apiVersion": "2023-05-01",
            "name": "[parameters('containerAppsEnvironmentName')]",
            "location": "[parameters('location')]",
            "properties": {
                "appLogsConfiguration": {
                    "destination": "log-analytics",
                    "logAnalyticsConfiguration": {
                        "customerId": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', concat('law-', variables('uniqueString'))), '2022-10-01').customerId]",
                        "sharedKeys": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', concat('law-', variables('uniqueString'))), '2022-10-01')]"
                    }
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', concat('law-', variables('uniqueString')))]"
            ]
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces",
            "apiVersion": "2022-10-01",
            "name": "[concat('law-', variables('uniqueString'))]",
            "location": "[parameters('location')]",
            "properties": {
                "sku": {
                    "name": "PerGB2018"
                }
            }
        },
        {
            "type": "Microsoft.KeyVault/vaults",
            "apiVersion": "2023-02-01",
            "name": "[variables('keyVaultName')]",
            "location": "[parameters('location')]",
            "properties": {
                "sku": {
                    "family": "A",
                    "name": "Standard"
                },
                "tenantId": "[subscription().tenantId]",
                "accessPolicies": [],
                "enabledForDeployment": true,
                "enabledForDiskEncryption": true,
                "enabledForTemplateDeployment": true
            }
        },
        {
            "type": "Microsoft.Insights/components",
            "apiVersion": "2020-02-02",
            "name": "[variables('appInsightsName')]",
            "location": "[parameters('location')]",
            "kind": "web",
            "properties": {
                "Application_Type": "web"
            }
        }
    ],
    "outputs": {
        "containerRegistryName": {
            "type": "string",
            "value": "[variables('containerRegistryName')]"
        },
        "postgresServerName": {
            "type": "string",
            "value": "[variables('postgresServerName')]"
        },
        "serviceBusNamespaceName": {
            "type": "string",
            "value": "[variables('serviceBusNamespaceName')]"
        },
        "storageAccountName": {
            "type": "string",
            "value": "[variables('storageAccountName')]"
        },
        "cosmosDbAccountName": {
            "type": "string",
            "value": "[variables('cosmosDbAccountName')]"
        },
        "aiSearchServiceName": {
            "type": "string",
            "value": "[variables('aiSearchServiceName')]"
        },
        "keyVaultName": {
            "type": "string",
            "value": "[variables('keyVaultName')]"
        },
        "appInsightsName": {
            "type": "string",
            "value": "[variables('appInsightsName')]"
        }
    }
}